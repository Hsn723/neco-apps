apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/name: contour
  name: contour
  namespace: projectcontour
spec:
  strategy:
  selector:
    matchLabels:
      app.kubernetes.io/name: contour
  template:
    metadata:
      labels:
        app.kubernetes.io/name: contour
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: contour
              topologyKey: "cke.cybozu.com/rack"
      containers:
      - image: quay.io/cybozu/contour:1.0.0.1
        args:
        - serve
        - --incluster
        - --use-extensions-v1beta1-ingress
        - --xds-address=0.0.0.0
        - --xds-port=8001
        - --envoy-service-http-port=8080
        - --envoy-service-https-port=8443
        - --contour-cafile=/certs/ca.crt
        - --contour-cert-file=/certs/tls.crt
        - --contour-key-file=/certs/tls.key
        - --config-path=/config/contour.yaml
        volumeMounts:
          - name: contourcert
            mountPath: /certs
            readOnly: true
          - name: contour-config
            mountPath: /config
            readOnly: true
        name: contour
      - image: quay.io/cybozu/contour-plus:0.3.0
        name: contour-plus
        env:
          - name: CP_SERVICE_NAME
            value: ingress/contour-global
          - name: CP_DEFAULT_ISSUER_NAME
            value: clouddns
        - image: quay.io/cybozu/envoy:1.11.1.1
          name: envoy
          ports:
            - containerPort: 8080
              name: http
            - containerPort: 8443
              name: https
          command: ["envoy"]
          args:
            - --config-path /config/envoy.json
            - --service-cluster $(CONTOUR_NAMESPACE)
            - --service-node $(ENVOY_POD_NAME)
            - --log-level info
          env:
            - name: CONTOUR_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: ENVOY_POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8002
            initialDelaySeconds: 3
            periodSeconds: 3
          volumeMounts:
            - name: envoy-config
              mountPath: /config
          lifecycle:
            preStop:
              exec:
                command: ["wget", "-qO-", "http://localhost:9001/healthcheck/fail"]
      volumes:
        - name: contourcert
          secret:
            secretName: contourcert
        - name: contour-config
          configMap:
            name: contour
            defaultMode: 0644
            items:
            - key: contour.yaml
              path: contour.yaml
